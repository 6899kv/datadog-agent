---
.system-probe_build_common:
  before_script:
    - !reference [.retrieve_linux_go_deps]
  script:
    - inv check-go-version
    - inv -e system-probe.build --strip-object-files
    # fail if references to glibc >= 2.18
    - objdump -p $CI_PROJECT_DIR/$SYSTEM_PROBE_BINARIES_DIR/system-probe | egrep 'GLIBC_2\.(1[8-9]|[2-9][0-9])' && exit 1
    # copy binary and eBPF objects to S3
    - $S3_VERBOSE_CP_CMD $CI_PROJECT_DIR/$SYSTEM_PROBE_BINARIES_DIR/system-probe $S3_ARTIFACTS_URI/system-probe/$ARCH/bin/system-probe
    - $S3_VERBOSE_CP_CMD $CI_PROJECT_DIR/pkg/ebpf/bytecode/build/ $S3_ARTIFACTS_URI/system-probe/$ARCH/ebpf/ --exclude "*" --include "*.o"
    - $S3_VERBOSE_CP_CMD $CI_PROJECT_DIR/pkg/ebpf/bytecode/build/co-re/ $S3_ARTIFACTS_URI/system-probe/$ARCH/ebpf/co-re/ --exclude "*" --include "*.o"
    - $S3_VERBOSE_CP_CMD $CI_PROJECT_DIR/pkg/ebpf/bytecode/build/runtime/ $S3_ARTIFACTS_URI/system-probe/$ARCH/ebpf/runtime/ --exclude "*" --include "*.c"
  variables:
    KUBERNETES_MEMORY_REQUEST: "6Gi"
    KUBERNETES_MEMORY_LIMIT: "12Gi"

build_system-probe-x64:
  stage: binary_build
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/system-probe_x64$DATADOG_AGENT_SYSPROBE_BUILDIMAGES_SUFFIX:$DATADOG_AGENT_SYSPROBE_BUILDIMAGES
  tags: ["arch:amd64"]
  needs: ["go_deps"]
  extends: .system-probe_build_common
  variables:
    ARCH: amd64

build_system-probe-arm64:
  stage: binary_build
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/system-probe_arm64$DATADOG_AGENT_SYSPROBE_BUILDIMAGES_SUFFIX:$DATADOG_AGENT_SYSPROBE_BUILDIMAGES
  needs: ["go_deps"]
  tags: ["arch:arm64"]
  extends: .system-probe_build_common
  variables:
    ARCH: arm64
