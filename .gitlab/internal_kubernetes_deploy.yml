---
# internal_kubernetes_deploy stage
# Contains jobs to trigger a pipeline in our k8s-datadog-agent-ops repo

include:
  - remote: https://gitlab-templates.ddbuild.io/slack-notifier/v2/template.yml

.internal_kubernetes_deploy:
  stage: internal_kubernetes_deploy
  artifacts:
    untracked: true
  rules:
  - if: $FORCE_K8S_DEPLOYMENT == "true"
    when: always
#  - if: $CI_COMMIT_BRANCH != "main"
#    when: never
  - !reference [.on_deploy_a7]
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64$DATADOG_AGENT_BUILDIMAGES_SUFFIX:$DATADOG_AGENT_BUILDIMAGES
  tags: ["arch:amd64"]
  variables:
    OPTION_AUTOMATIC_ROLLOUT: "true"
    SKIP_PLAN_CHECK: "true"
    WORKFLOW: "agents"
    FORCE_DEPLOYMENT: "true"
  script:
    - source /root/.bashrc
    - export GITLAB_TOKEN=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.gitlab_pipelines_scheduler_token --with-decryption --query "Parameter.Value" --out text)
#    - inv pipeline.trigger-child-pipeline --project-name "DataDog/k8s-datadog-agent-ops" --git-ref "main" --variables "OPTION_AUTOMATIC_ROLLOUT,WORKFLOW,OPTION_PRE_SCRIPT,FILTER,SKIP_PLAN_CHECK,FORCE_DEPLOYMENT"
#    - export GH_TOKEN=$(aws ssm get-parameter --region us-east-1 --name github.user.datadog-compute-robot --with-decryption --query "Parameter.Value" --out text)
#    - .gitlab/scripts/generate_changelog.sh
    - python3 -m pip install -r tasks/libs/requirements-notifications.txt
    - inv pipeline.changelog ${CI_COMMIT_SHORT_SHA}

#internal_kubernetes_deploy_snowver:
#  extends: .internal_kubernetes_deploy
#  needs:
#    - job: docker_trigger_internal
#      artifacts: false
#    - job: docker_trigger_cluster_agent_internal
#      artifacts: false
#    - job: k8s-e2e-main # Currently only require container Argo workflow
#      artifacts: false
#      optional: true
#  variables:
#    OPTION_PRE_SCRIPT: "patch-cluster-images-operator.sh snowver ${CI_COMMIT_REF_SLUG}-jmx-${CI_COMMIT_SHORT_SHA} ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
#    FILTER: "cluster.shortName == 'snowver'"

internal_kubernetes_deploy_stripe:
  extends: .internal_kubernetes_deploy
#  needs:
#    - job: internal_kubernetes_deploy_snowver
  when: manual
  variables:
    OPTION_PRE_SCRIPT: "patch-cluster-images-operator.sh stripe ${CI_COMMIT_REF_SLUG}-jmx-${CI_COMMIT_SHORT_SHA} ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    FILTER: "cluster.shortName =='stripe'"


notify-slack:
  stage: internal_kubernetes_deploy
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/slack-notifier:latest
  tags: ["arch:amd64"]
  needs:
    - job: internal_kubernetes_deploy_stripe
  dependencies:
    - internal_kubernetes_deploy_stripe
  script:
    - |
      postmessage "system-probe-ops" "$(cat system_probe_commits.txt)"
      while IFS= read -r email; do
        echo "Processing email: $email"
        result=$(email2slackid "$email" || echo "$email")
        results+=("$result")
        echo "Result for $email: $result"
      done < unique_emails.txt
      echo "$(cat unique_emails.txt)"
      echo "Results array: ${results[@]}"
      echo "Unique Authors: $(printf " %s" "${results[@]}")"
      specific_email="adam.karpowich@datadoghq.com"
      echo "Result for specific email ($specific_email): $(email2slackid "$specific_email")"
      git checkout ${CI_COMMIT_SHORT_SHA}
      #    - git tag stripe_staging
      #    - git push origin stripe_staging
