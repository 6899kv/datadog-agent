description: >
  Simulates a relatively busy application server on which DogStatsD metrics,
  traces and TCP streamed logs are present on which the client user is
  interested in OTeL but has not made a complete transition. DogStatsD, TCP logs,
  and APM traces make up the load. We make claims about throughput, UDS packet
  loss and memory, CPU resource consumption.

teams: []

labels: {}

checks:
  - name: memory_usage
    description: "Memory usage"
    bounds:
      series: rss_bytes
      # The machine has 12Gb free.
      upper_bound: 3.5Gb

  - name: cpu_utilization
    description: "CPU utilization"
    bounds:
      series: cpu_percentage
      # The machine has 8 cores available.
      upper_bound: 400

  - name: apm_trace_throughput
    description: "APM throughput"
    bounds:
      series: "rate(bytes_written['traces'])"
      # Lading is configured to send 8 MB/s on each of two connections.
      lower_bound: 10Mb
      upper_bound: 20Mb

  - name: dogstatsd_throughput
    description: "DogStatsD throughput"
    bounds:
      series: "rate(bytes_written['dogstatsd'])"
      # Lading is configured to send 70 MB/s.
      lower_bound: 60Mb
      upper_bound: 80Mb

  - name: tcp_listener_throughput
    description: "TCP listener throughput"
    bounds:
      series: "rate(bytes_written['tcp_logs'])"
      # Lading is configured to send 10 MB/s each on 4 connections.
      # More throughput than this -- owing to buffering etc
      # -- is fine but less is not.
      lower_bound: 30Mb
      upper_bound: 50Mb

  - name: lost_bytes_uds_dogstatsd
    description: "Lost UDS DogStatsD bytes"
    percent_error:
      expected: "bytes_written['dogstatsd']"
      actual: "target/dogstatsd.uds_packets_bytes"
      threshold: 0.5

environment:
  DD_TELEMETRY_ENABLED: true
  DD_API_KEY: 00000001

profiling_environment:
  DD_INTERNAL_PROFILING_ENABLED: true
  DD_INTERNAL_PROFILING_UNIX_SOCKET: /var/run/datadog/apm.socket
  DD_INTERNAL_PROFILING_DELTA_PROFILES: true
  DD_INTERNAL_PROFILING_ENABLE_GOROUTINE_STACKTRACES: true

  DD_INTERNAL_PROFILING_BLOCK_PROFILE_RATE: 10000
  DD_INTERNAL_PROFILING_CPU_DURATION: 1m
  DD_INTERNAL_PROFILING_DELTA_PROFILES: true
  DD_INTERNAL_PROFILING_MUTEX_PROFILE_FRACTION: 10
  DD_INTERNAL_PROFILING_PERIOD: 1m

  DD_PROFILING_EXECUTION_TRACE_ENABLED: true
  DD_PROFILING_EXECUTION_TRACE_PERIOD: 1m
  DD_PROFILING_WAIT_PROFILE: true

  DD_INTERNAL_PROFILING_EXTRA_TAGS: workload:app-server
